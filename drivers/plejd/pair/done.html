<script type="text/javascript">
    Homey.setTitle(__('pair.title.done'));

    document.getElementById("done_instructions").innerHTML = __('pair.select.done');

    Homey.emit('getPairingDevice', {}, (err, pairingDevice) => {
        if (err) {
            Homey.alert(err);
        } else {
            console.log('Retrieved settings from backend');
            console.log(pairingDevice);
            if (pairingDevice) {
              Homey.emit('saveSettings', pairingDevice.cryptokey, (err, result) => {
                  debugger;
                  console.log("No error returned from backend");
                  if (!err) {
                    Homey.addDevice({
                      name: pairingDevice.name,
                      data: {
                        id: guid(),
                        plejdId: pairingDevice.id,
                      }
                    }, (err, res) => {
                      if (err) {
                        console.log(err);
                        return;
                      }

                      Homey.done();
                    });
                  } else {
                      Homey.alert(err);
                  }
              });
            }
        }
    });

    function guid() {
      function s4() {
        return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
      }
      return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
    }

</script>

<p id='done_instructions'></p>
